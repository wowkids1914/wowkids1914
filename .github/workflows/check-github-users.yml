name: Check GitHub Users

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/check-github-users.yml'
      - 'data.json'

jobs:
  check-users:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Filter valid GitHub users
        run: |
          set -e

          # Print data.json for debugging
          cat data.json
          jq . data.json

          # Ensure each row is quoted and handled correctly (avoid jq parse error)
          jq -c '.[]' data.json | while read -r row; do
            username=$(echo "$row" | jq -r '.[0]')
            # 请求用户主页
            status=$(curl -s -o /dev/null -w "%{http_code}" "https://github.com/${username}")
            echo "Checking $username: $status"
            
            if [ "$status" != "200" ] && [ "$status" != "404" ]; then
              echo "Unexpected status $status for $username"
              exit 1
            fi

            if [ "$status" = "200" ]; then
              echo "$row"
            fi
            # 延迟 1.5 秒
            sleep 1.5
          done > valid.json

          # 如果 valid.json 为空，写入空数组，防止 jq 报错
          if [ ! -s valid.json ]; then
            echo "[]" > valid.json
          fi

          # 合并为数组格式并覆盖 data.json
          jq -s '.' valid.json > data.json
          rm -f valid.json

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 筛选有效 GitHub 用户
          file_pattern: data.json